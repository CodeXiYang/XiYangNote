# Redis

> è§†é¢‘: https://www.bilibili.com/video/BV1jD4y1Q7tU

## 1. NoSQLçš„å¼•è¨€

**NoSQL**(` Not Only SQL` )ï¼Œæ„å³**ä¸ä»…ä»…æ˜¯SQL**, æ³›æŒ‡éå…³ç³»å‹çš„æ•°æ®åº“ã€‚Nosqlè¿™ä¸ªæŠ€æœ¯é—¨ç±»,æ—©æœŸå°±æœ‰äººæå‡º,å‘å±•è‡³2009å¹´è¶‹åŠ¿è¶Šå‘é«˜æ¶¨ã€‚

## 2. ä¸ºä»€ä¹ˆæ˜¯NoSQL

éšç€äº’è”ç½‘ç½‘ç«™çš„å…´èµ·ï¼Œä¼ ç»Ÿçš„å…³ç³»æ•°æ®åº“åœ¨åº”ä»˜åŠ¨æ€ç½‘ç«™ï¼Œç‰¹åˆ«æ˜¯è¶…å¤§è§„æ¨¡å’Œé«˜å¹¶å‘çš„çº¯åŠ¨æ€ç½‘ç«™å·²ç»æ˜¾å¾—åŠ›ä¸ä»å¿ƒï¼Œæš´éœ²äº†å¾ˆå¤šéš¾ä»¥å…‹æœçš„é—®é¢˜ã€‚å¦‚`å•†åŸç½‘ç«™ä¸­å¯¹å•†å“æ•°æ®é¢‘ç¹æŸ¥è¯¢`ã€`å¯¹çƒ­æœå•†å“çš„æ’è¡Œç»Ÿè®¡`ã€`è®¢å•è¶…æ—¶é—®é¢˜`
ã€ä»¥åŠå¾®ä¿¡æœ‹å‹åœˆï¼ˆéŸ³é¢‘ï¼Œè§†é¢‘ï¼‰å­˜å‚¨ç­‰ç›¸å…³ä½¿ç”¨ä¼ ç»Ÿçš„å…³ç³»å‹æ•°æ®åº“å®ç°å°±æ˜¾å¾—éå¸¸å¤æ‚ï¼Œè™½ç„¶èƒ½å®ç°ç›¸åº”åŠŸèƒ½ä½†æ˜¯åœ¨æ€§èƒ½ä¸Šå´ä¸æ˜¯é‚£ä¹ˆä¹è§‚ã€‚nosqlè¿™ä¸ªæŠ€æœ¯é—¨ç±»çš„å‡ºç°ï¼Œæ›´å¥½çš„è§£å†³äº†è¿™äº›é—®é¢˜ï¼Œå®ƒå‘Šè¯‰äº†ä¸–ç•Œä¸ä»…ä»…æ˜¯sqlã€‚

## 3. NoSQLçš„å››å¤§åˆ†ç±»

### 3.1 é”®å€¼(Key-Value)å­˜å‚¨æ•°æ®åº“

```markdown
# 1.è¯´æ˜: 
- è¿™ä¸€ç±»æ•°æ®åº“ä¸»è¦ä¼šä½¿ç”¨åˆ°ä¸€ä¸ªå“ˆå¸Œè¡¨ï¼Œè¿™ä¸ªè¡¨ä¸­æœ‰ä¸€ä¸ªç‰¹å®šçš„é”®å’Œä¸€ä¸ªæŒ‡é’ˆæŒ‡å‘ç‰¹å®šçš„æ•°æ®ã€‚

# 2.ç‰¹ç‚¹
- Key/valueæ¨¡å‹å¯¹äºITç³»ç»Ÿæ¥è¯´çš„ä¼˜åŠ¿åœ¨äºç®€å•ã€æ˜“éƒ¨ç½²ã€‚  
- ä½†æ˜¯å¦‚æœDBAåªå¯¹éƒ¨åˆ†å€¼è¿›è¡ŒæŸ¥è¯¢æˆ–æ›´æ–°çš„æ—¶å€™ï¼ŒKey/valueå°±æ˜¾å¾—æ•ˆç‡ä½ä¸‹äº†ã€‚

# 3.ç›¸å…³äº§å“
- Tokyo Cabinet/Tyrant,
- Redis
- SSDB
- Voldemort 
- Oracle BDB
```

### 3.2 åˆ—å­˜å‚¨æ•°æ®åº“

```markdown
# 1.è¯´æ˜
- è¿™éƒ¨åˆ†æ•°æ®åº“é€šå¸¸æ˜¯ç”¨æ¥åº”å¯¹åˆ†å¸ƒå¼å­˜å‚¨çš„æµ·é‡æ•°æ®ã€‚

# 2.ç‰¹ç‚¹
- é”®ä»ç„¶å­˜åœ¨ï¼Œä½†æ˜¯å®ƒä»¬çš„ç‰¹ç‚¹æ˜¯æŒ‡å‘äº†å¤šä¸ªåˆ—ã€‚è¿™äº›åˆ—æ˜¯ç”±åˆ—å®¶æ—æ¥å®‰æ’çš„ã€‚

# 3.ç›¸å…³äº§å“
- Cassandraã€HBaseã€Riak.
```

### 3.3 æ–‡æ¡£å‹æ•°æ®åº“

```markdown
# 1.è¯´æ˜
- æ–‡æ¡£å‹æ•°æ®åº“çš„çµæ„Ÿæ˜¯æ¥è‡ªäºLotus NotesåŠå…¬è½¯ä»¶çš„ï¼Œè€Œä¸”å®ƒåŒç¬¬ä¸€ç§é”®å€¼å­˜å‚¨ç›¸ç±»ä¼¼è¯¥ç±»å‹çš„æ•°æ®æ¨¡å‹æ˜¯ç‰ˆæœ¬åŒ–çš„æ–‡æ¡£ï¼ŒåŠç»“æ„åŒ–çš„æ–‡æ¡£ä»¥ç‰¹å®šçš„æ ¼å¼å­˜å‚¨ï¼Œæ¯”å¦‚JSONã€‚æ–‡æ¡£å‹æ•°æ®åº“å¯ ä»¥çœ‹ä½œæ˜¯é”®å€¼æ•°æ®åº“çš„å‡çº§ç‰ˆï¼Œå…è®¸ä¹‹é—´åµŒå¥—é”®å€¼ã€‚è€Œä¸”æ–‡æ¡£å‹æ•°æ®åº“æ¯”é”®å€¼æ•°æ®åº“çš„æŸ¥è¯¢æ•ˆç‡æ›´é«˜

# 2.ç‰¹ç‚¹
- ä»¥æ–‡æ¡£å½¢å¼å­˜å‚¨

# 3.ç›¸å…³äº§å“
- MongoDBã€CouchDBã€ MongoDb(4.x). å›½å†…ä¹Ÿæœ‰æ–‡æ¡£å‹æ•°æ®åº“SequoiaDBï¼Œå·²ç»å¼€æºã€‚
```

### 3.4 å›¾å½¢(Graph)æ•°æ®åº“

 ```markdown
# 1.è¯´æ˜
- å›¾å½¢ç»“æ„çš„æ•°æ®åº“åŒå…¶ä»–è¡Œåˆ—ä»¥åŠåˆšæ€§ç»“æ„çš„SQLæ•°æ®åº“ä¸åŒï¼Œå®ƒæ˜¯ä½¿ç”¨çµæ´»çš„å›¾å½¢æ¨¡å‹ï¼Œå¹¶ä¸”èƒ½å¤Ÿæ‰©å±•åˆ°å¤šä¸ªæœåŠ¡å™¨ä¸Šã€‚
- NoSQLæ•°æ®åº“æ²¡æœ‰æ ‡å‡†çš„æŸ¥è¯¢è¯­è¨€(SQL)ï¼Œå› æ­¤è¿›è¡Œæ•°æ®åº“æŸ¥è¯¢éœ€è¦åˆ¶å®šæ•°æ®æ¨¡å‹ã€‚è®¸å¤šNoSQLæ•°æ®åº“éƒ½æœ‰RESTå¼çš„æ•°æ®æ¥å£æˆ–è€…æŸ¥è¯¢APIã€‚

# 2.ç‰¹ç‚¹

# 3.ç›¸å…³äº§å“
- Neo4Jã€InfoGridã€ Infinite Graphã€
 ```

----

## 4. NoSQLåº”ç”¨åœºæ™¯

- æ•°æ®æ¨¡å‹æ¯”è¾ƒç®€å•

- éœ€è¦çµæ´»æ€§æ›´å¼ºçš„ITç³»ç»Ÿ

- å¯¹æ•°æ®åº“æ€§èƒ½è¦æ±‚è¾ƒé«˜

- ä¸éœ€è¦é«˜åº¦çš„æ•°æ®ä¸€è‡´æ€§

## 5. ä»€ä¹ˆæ˜¯Redis

![image-20200623121234046](assets/image-20200623121234046.png)

> Redis is an open source (BSD licensed), in-memory data structure store, used as a database, cache and message broker.

Redis å¼€æº éµå¾ªBSD åŸºäºå†…å­˜æ•°æ®å­˜å‚¨ è¢«ç”¨äºä½œä¸º æ•°æ®åº“ ç¼“å­˜ æ¶ˆæ¯ä¸­é—´ä»¶

- æ€»ç»“: redisæ˜¯ä¸€ä¸ªå†…å­˜å‹çš„æ•°æ®åº“

## 6. Redisç‰¹ç‚¹

- Redisæ˜¯ä¸€ä¸ªé«˜æ€§èƒ½key/valueå†…å­˜å‹æ•°æ®åº“

- Redisæ”¯æŒä¸°å¯Œçš„æ•°æ®ç±»å‹

- Redisæ”¯æŒæŒä¹…åŒ–

- Rediså•çº¿ç¨‹,å•è¿›ç¨‹

---

## 7. Rediså®‰è£…

```markdown
# 0.å‡†å¤‡ç¯å¢ƒ
- vmware15.x+
- centos7.x+

# 1.ä¸‹è½½redisæºç åŒ…
- https://redis.io/
```

![image-20200623121621195](assets/image-20200623121621195.png)

```markdown
# 2.ä¸‹è½½å®Œæ•´æºç åŒ…
- redis-4.0.10.tar.gz
```

![image-20200623123918876](assets/image-20200623123918876.png)

```markdown
# 3.å°†ä¸‹è½½redisèµ„æ–™åŒ…ä¸Šä¼ åˆ°Linuxä¸­
```

![image-20200623124327319](assets/image-20200623124327319.png)

```markdown
# 4.è§£å‹ç¼©æ–‡ä»¶
[root@localhost ~]# tar -zxvf redis-4.0.10.tar.gz
[root@localhost ~]# ll
```

![image-20200623124522026](assets/image-20200623124522026.png)

```markdown
# 5.å®‰è£…gcc  
- yum install -y gcc

# 6.è¿›å…¥è§£å‹ç¼©ç›®å½•æ‰§è¡Œå¦‚ä¸‹å‘½ä»¤
- make MALLOC=libc

# 7.ç¼–è¯‘å®Œæˆåæ‰§è¡Œå¦‚ä¸‹å‘½ä»¤
- make install PREFIX=/usr/redis

# 8.è¿›å…¥/usr/redisç›®å½•å¯åŠ¨redisæœåŠ¡ 
- ./redis-server
```

![image-20200623125420505](assets/image-20200623125420505.png)

```markdown
# 9.RedisæœåŠ¡ç«¯å£é»˜è®¤æ˜¯ 6379

# 10.è¿›å…¥binç›®å½•æ‰§è¡Œå®¢æˆ·ç«¯è¿æ¥æ“ä½œ
- ./redis-cli â€“p 6379
```

![image-20200623125716013](assets/image-20200623125716013.png)

```markdown
# 11.è¿æ¥æˆåŠŸå‡ºç°ä¸Šé¢ç•Œé¢è¿æ¥æˆåŠŸ
```

## 8. Redisæ•°æ®åº“ç›¸å…³æŒ‡ä»¤

### 8.1 æ•°æ®åº“æ“ä½œæŒ‡ä»¤

```markdown
# 1.Redisä¸­åº“è¯´æ˜
- ä½¿ç”¨redisçš„é»˜è®¤é…ç½®å™¨åŠ¨redisæœåŠ¡å,é»˜è®¤ä¼šå­˜åœ¨16ä¸ªåº“,ç¼–å·ä»0-15
- å¯ä»¥ä½¿ç”¨select åº“çš„ç¼–å· æ¥é€‰æ‹©ä¸€ä¸ªredisçš„åº“

# 2.Redisä¸­æ“ä½œåº“çš„æŒ‡ä»¤
- æ¸…ç©ºå½“å‰çš„åº“  FLUSHDB
- æ¸…ç©ºå…¨éƒ¨çš„åº“  FLUSHALL

# 3.rediså®¢æˆ·ç«¯æ˜¾ç¤ºä¸­æ–‡
-	./redis-cli  -p 7000 --raw
```

### 8.2 æ“ä½œkeyç›¸å…³æŒ‡ä»¤

```markdown
# 1.DELæŒ‡ä»¤
- è¯­æ³• :  DEL key [key ...] 
- ä½œç”¨ :  åˆ é™¤ç»™å®šçš„ä¸€ä¸ªæˆ–å¤šä¸ªkey ã€‚ä¸å­˜åœ¨çš„key ä¼šè¢«å¿½ç•¥ã€‚
- å¯ç”¨ç‰ˆæœ¬ï¼š >= 1.0.0
- è¿”å›å€¼ï¼š è¢«åˆ é™¤key çš„æ•°é‡ã€‚ 

# 2.EXISTSæŒ‡ä»¤
- è¯­æ³•:  EXISTS key
- ä½œç”¨:  æ£€æŸ¥ç»™å®škey æ˜¯å¦å­˜åœ¨ã€‚
- å¯ç”¨ç‰ˆæœ¬ï¼š >= 1.0.0
- è¿”å›å€¼ï¼š è‹¥key å­˜åœ¨ï¼Œè¿”å›1 ï¼Œå¦åˆ™è¿”å›0ã€‚

# 3.EXPIRE
- è¯­æ³•:  EXPIRE key seconds
- ä½œç”¨:  ä¸ºç»™å®škey è®¾ç½®ç”Ÿå­˜æ—¶é—´ï¼Œå½“key è¿‡æœŸæ—¶(ç”Ÿå­˜æ—¶é—´ä¸º0 )ï¼Œå®ƒä¼šè¢«è‡ªåŠ¨åˆ é™¤ã€‚
- å¯ç”¨ç‰ˆæœ¬ï¼š >= 1.0.0
- æ—¶é—´å¤æ‚åº¦ï¼š O(1)
- è¿”å›å€¼ï¼šè®¾ç½®æˆåŠŸè¿”å›1 ã€‚

# 4.KEYS
- è¯­æ³• :  KEYS pattern
- ä½œç”¨ :  æŸ¥æ‰¾æ‰€æœ‰ç¬¦åˆç»™å®šæ¨¡å¼pattern çš„key ã€‚
- è¯­æ³•:
	KEYS * åŒ¹é…æ•°æ®åº“ä¸­æ‰€æœ‰key ã€‚
	KEYS h?llo åŒ¹é…hello ï¼Œhallo å’Œhxllo ç­‰ã€‚
	KEYS h*llo åŒ¹é…hllo å’Œheeeeello ç­‰ã€‚
	KEYS h[ae]llo åŒ¹é…hello å’Œhallo ï¼Œä½†ä¸åŒ¹é…hillo ã€‚ç‰¹æ®Šç¬¦å·ç”¨ "\" éš”å¼€
- å¯ç”¨ç‰ˆæœ¬ï¼š >= 1.0.0
- è¿”å›å€¼ï¼š ç¬¦åˆç»™å®šæ¨¡å¼çš„key åˆ—è¡¨ã€‚

# 5.MOVE
- è¯­æ³• :  MOVE key db
- ä½œç”¨ :  å°†å½“å‰æ•°æ®åº“çš„key ç§»åŠ¨åˆ°ç»™å®šçš„æ•°æ®åº“db å½“ä¸­ã€‚
- å¯ç”¨ç‰ˆæœ¬ï¼š >= 1.0.0
- è¿”å›å€¼ï¼š ç§»åŠ¨æˆåŠŸè¿”å›1 ï¼Œå¤±è´¥åˆ™è¿”å›0 ã€‚

# 6.PEXPIRE
- è¯­æ³• :  PEXPIRE key milliseconds
- ä½œç”¨ :  è¿™ä¸ªå‘½ä»¤å’ŒEXPIRE å‘½ä»¤çš„ä½œç”¨ç±»ä¼¼ï¼Œä½†æ˜¯å®ƒä»¥æ¯«ç§’ä¸ºå•ä½è®¾ç½®key çš„ç”Ÿå­˜æ—¶é—´ï¼Œè€Œä¸åƒEXPIRE å‘½ä»¤é‚£æ ·ï¼Œä»¥ç§’ä¸ºå•ä½ã€‚
- å¯ç”¨ç‰ˆæœ¬ï¼š >= 2.6.0
- æ—¶é—´å¤æ‚åº¦ï¼š O(1)
- è¿”å›å€¼ï¼šè®¾ç½®æˆåŠŸï¼Œè¿”å›1  key ä¸å­˜åœ¨æˆ–è®¾ç½®å¤±è´¥ï¼Œè¿”å›0

# 7.PEXPIREAT
- è¯­æ³• :  PEXPIREAT key milliseconds-timestamp
- ä½œç”¨ :  è¿™ä¸ªå‘½ä»¤å’ŒEXPIREAT å‘½ä»¤ç±»ä¼¼ï¼Œä½†å®ƒä»¥æ¯«ç§’ä¸ºå•ä½è®¾ç½®key çš„è¿‡æœŸunix æ—¶é—´æˆ³ï¼Œè€Œä¸æ˜¯åƒEXPIREATé‚£æ ·ï¼Œä»¥ç§’ä¸ºå•ä½ã€‚
- å¯ç”¨ç‰ˆæœ¬ï¼š >= 2.6.0
- è¿”å›å€¼ï¼šå¦‚æœç”Ÿå­˜æ—¶é—´è®¾ç½®æˆåŠŸï¼Œè¿”å›1 ã€‚å½“key ä¸å­˜åœ¨æˆ–æ²¡åŠæ³•è®¾ç½®ç”Ÿå­˜æ—¶é—´æ—¶ï¼Œè¿”å›0 ã€‚(æŸ¥çœ‹EXPIRE å‘½ä»¤è·å–æ›´å¤šä¿¡æ¯)

# 8.TTL
- è¯­æ³• :   TTL key
- ä½œç”¨ :   ä»¥ç§’ä¸ºå•ä½ï¼Œè¿”å›ç»™å®škey çš„å‰©ä½™ç”Ÿå­˜æ—¶é—´(TTL, time to live)ã€‚
- å¯ç”¨ç‰ˆæœ¬ï¼š >= 1.0.0
- è¿”å›å€¼ï¼š
	å½“key ä¸å­˜åœ¨æ—¶ï¼Œè¿”å›-2 ã€‚
	å½“key å­˜åœ¨ä½†æ²¡æœ‰è®¾ç½®å‰©ä½™ç”Ÿå­˜æ—¶é—´æ—¶ï¼Œè¿”å›-1 ã€‚
	å¦åˆ™ï¼Œä»¥ç§’ä¸ºå•ä½ï¼Œè¿”å›key çš„å‰©ä½™ç”Ÿå­˜æ—¶é—´ã€‚
- Note : åœ¨Redis 2.8 ä»¥å‰ï¼Œå½“key ä¸å­˜åœ¨ï¼Œæˆ–è€…key æ²¡æœ‰è®¾ç½®å‰©ä½™ç”Ÿå­˜æ—¶é—´æ—¶ï¼Œå‘½ä»¤éƒ½è¿”å›-1 ã€‚

# 9.PTTL
- è¯­æ³• :  PTTL key
- ä½œç”¨ :  è¿™ä¸ªå‘½ä»¤ç±»ä¼¼äºTTL å‘½ä»¤ï¼Œä½†å®ƒä»¥æ¯«ç§’ä¸ºå•ä½è¿”å›key çš„å‰©ä½™ç”Ÿå­˜æ—¶é—´ï¼Œè€Œä¸æ˜¯åƒTTL å‘½ä»¤é‚£æ ·ï¼Œä»¥ç§’ä¸ºå•ä½ã€‚
- å¯ç”¨ç‰ˆæœ¬ï¼š >= 2.6.0
- è¿”å›å€¼ï¼š å½“key ä¸å­˜åœ¨æ—¶ï¼Œè¿”å›-2 ã€‚å½“key å­˜åœ¨ä½†æ²¡æœ‰è®¾ç½®å‰©ä½™ç”Ÿå­˜æ—¶é—´æ—¶ï¼Œè¿”å›-1 ã€‚
- å¦åˆ™ï¼Œä»¥æ¯«ç§’ä¸ºå•ä½ï¼Œè¿”å›key çš„å‰©ä½™ç”Ÿå­˜æ—¶é—´ã€‚
- æ³¨æ„ : åœ¨Redis 2.8 ä»¥å‰ï¼Œå½“key ä¸å­˜åœ¨ï¼Œæˆ–è€…key æ²¡æœ‰è®¾ç½®å‰©ä½™ç”Ÿå­˜æ—¶é—´æ—¶ï¼Œå‘½ä»¤éƒ½è¿”å›-1 ã€‚

# 10.RANDOMKEY
- è¯­æ³• :  RANDOMKEY
- ä½œç”¨ :  ä»å½“å‰æ•°æ®åº“ä¸­éšæœºè¿”å›(ä¸åˆ é™¤) ä¸€ä¸ªkey ã€‚
- å¯ç”¨ç‰ˆæœ¬ï¼š >= 1.0.0
- è¿”å›å€¼ï¼šå½“æ•°æ®åº“ä¸ä¸ºç©ºæ—¶ï¼Œè¿”å›ä¸€ä¸ªkey ã€‚å½“æ•°æ®åº“ä¸ºç©ºæ—¶ï¼Œè¿”å›nil ã€‚

# 11.RENAME
- è¯­æ³• :  RENAME key newkey
- ä½œç”¨ :  å°†key æ”¹åä¸ºnewkey ã€‚å½“key å’Œnewkey ç›¸åŒï¼Œæˆ–è€…key ä¸å­˜åœ¨æ—¶ï¼Œè¿”å›ä¸€ä¸ªé”™è¯¯ã€‚å½“newkey å·²ç»å­˜åœ¨æ—¶ï¼ŒRENAME å‘½ä»¤å°†è¦†ç›–æ—§å€¼ã€‚
- å¯ç”¨ç‰ˆæœ¬ï¼š >= 1.0.0
- è¿”å›å€¼ï¼š æ”¹åæˆåŠŸæ—¶æç¤ºOK ï¼Œå¤±è´¥æ—¶å€™è¿”å›ä¸€ä¸ªé”™è¯¯ã€‚

# 12.TYPE
- è¯­æ³• :  TYPE key
- ä½œç”¨ :  è¿”å›key æ‰€å‚¨å­˜çš„å€¼çš„ç±»å‹ã€‚
- å¯ç”¨ç‰ˆæœ¬ï¼š >= 1.0.0
- è¿”å›å€¼ï¼š
	none (key ä¸å­˜åœ¨)
	string (å­—ç¬¦ä¸²)
	list (åˆ—è¡¨)
	set (é›†åˆ)
	zset (æœ‰åºé›†)
	hash (å“ˆå¸Œè¡¨)
```

### 8.3 Stringç±»å‹

#### 1. å†…å­˜å­˜å‚¨æ¨¡å‹

![image-20200623132104399](assets/image-20200623132104399.png)

#### 2. å¸¸ç”¨æ“ä½œå‘½ä»¤

| å‘½ä»¤                                       | è¯´æ˜                                       |
| ------------------------------------------ | ------------------------------------------ |
| set                                        | è®¾ç½®ä¸€ä¸ªkey/value                          |
| get                                        | æ ¹æ®keyè·å¾—å¯¹åº”çš„value                     |
| mset                                       | ä¸€æ¬¡è®¾ç½®å¤šä¸ªkey value                      |
| mget                                       | ä¸€æ¬¡è·å¾—å¤šä¸ªkeyçš„value                     |
| getset                                     | è·å¾—åŸå§‹keyçš„å€¼ï¼ŒåŒæ—¶è®¾ç½®æ–°å€¼              |
| strlen                                     | è·å¾—å¯¹åº”keyå­˜å‚¨valueçš„é•¿åº¦                 |
| append                                     | ä¸ºå¯¹åº”keyçš„valueè¿½åŠ å†…å®¹                   |
| getrange ç´¢å¼•0å¼€å§‹                         | æˆªå–valueçš„å†…å®¹                            |
| setex                                      | è®¾ç½®ä¸€ä¸ªkeyå­˜æ´»çš„æœ‰æ•ˆæœŸï¼ˆç§’ï¼‰              |
| psetex                                     | è®¾ç½®ä¸€ä¸ªkeyå­˜æ´»çš„æœ‰æ•ˆæœŸï¼ˆæ¯«ç§’ï¼‰            |
| setnx                                      | å­˜åœ¨ä¸åšä»»ä½•æ“ä½œ,ä¸å­˜åœ¨æ·»åŠ                 |
| msetnxåŸå­æ“ä½œ(åªè¦æœ‰ä¸€ä¸ªå­˜åœ¨ä¸åšä»»ä½•æ“ä½œ) | å¯ä»¥åŒæ—¶è®¾ç½®å¤šä¸ªkey,åªæœ‰æœ‰ä¸€ä¸ªå­˜åœ¨éƒ½ä¸ä¿å­˜ |
| decr                                       | è¿›è¡Œæ•°å€¼ç±»å‹çš„-1æ“ä½œ                       |
| decrby                                     | æ ¹æ®æä¾›çš„æ•°æ®è¿›è¡Œå‡æ³•æ“ä½œ                 |
| Incr                                       | è¿›è¡Œæ•°å€¼ç±»å‹çš„+1æ“ä½œ                       |
| incrby                                     | æ ¹æ®æä¾›çš„æ•°æ®è¿›è¡ŒåŠ æ³•æ“ä½œ                 |
| Incrbyfloat                                | æ ¹æ®æä¾›çš„æ•°æ®åŠ å…¥æµ®ç‚¹æ•°                   |

### 8.4 Listç±»å‹

list åˆ—è¡¨ ç›¸å½“äºjavaä¸­list é›†åˆ ç‰¹ç‚¹ å…ƒç´ æœ‰åº ä¸” å¯ä»¥é‡å¤

#### 1.å†…å­˜å­˜å‚¨æ¨¡å‹

![image-20200623161114380](assets/image-20200623161114380.png)

#### 2.å¸¸ç”¨æ“ä½œæŒ‡ä»¤

| å‘½ä»¤    | è¯´æ˜                                 |
| ------- | ------------------------------------ |
| lpush   | å°†æŸä¸ªå€¼åŠ å…¥åˆ°ä¸€ä¸ªkeyåˆ—è¡¨å¤´éƒ¨        |
| lpushx  | åŒlpush,ä½†æ˜¯å¿…é¡»è¦ä¿è¯è¿™ä¸ªkeyå­˜åœ¨    |
| rpush   | å°†æŸä¸ªå€¼åŠ å…¥åˆ°ä¸€ä¸ªkeyåˆ—è¡¨æœ«å°¾        |
| rpushx  | åŒrpush,ä½†æ˜¯å¿…é¡»è¦ä¿è¯è¿™ä¸ªkeyå­˜åœ¨    |
| lpop    | è¿”å›å’Œç§»é™¤åˆ—è¡¨å·¦è¾¹çš„ç¬¬ä¸€ä¸ªå…ƒç´        |
| rpop    | è¿”å›å’Œç§»é™¤åˆ—è¡¨å³è¾¹çš„ç¬¬ä¸€ä¸ªå…ƒç´        |
| lrange  | è·å–æŸä¸€ä¸ªä¸‹æ ‡åŒºé—´å†…çš„å…ƒç´            |
| llen    | è·å–åˆ—è¡¨å…ƒç´ ä¸ªæ•°                     |
| lset    | è®¾ç½®æŸä¸€ä¸ªæŒ‡å®šç´¢å¼•çš„å€¼(ç´¢å¼•å¿…é¡»å­˜åœ¨) |
| lindex  | è·å–æŸä¸€ä¸ªæŒ‡å®šç´¢å¼•ä½ç½®çš„å…ƒç´          |
| lrem    | åˆ é™¤é‡å¤å…ƒç´                          |
| ltrim   | ä¿ç•™åˆ—è¡¨ä¸­ç‰¹å®šåŒºé—´å†…çš„å…ƒç´            |
| linsert | åœ¨æŸä¸€ä¸ªå…ƒç´ ä¹‹å‰ï¼Œä¹‹åæ’å…¥æ–°å…ƒç´      |

### 8.5 Setç±»å‹

ç‰¹ç‚¹: Setç±»å‹ Seté›†åˆ å…ƒç´ æ— åº ä¸å¯ä»¥é‡å¤

#### 1.å†…å­˜å­˜å‚¨æ¨¡å‹

![image-20200623193634316](assets/image-20200623193634316.png)

#### 2.å¸¸ç”¨å‘½ä»¤

| å‘½ä»¤        | è¯´æ˜                                               |
| ----------- | -------------------------------------------------- |
| sadd        | ä¸ºé›†åˆæ·»åŠ å…ƒç´                                      |
| smembers    | æ˜¾ç¤ºé›†åˆä¸­æ‰€æœ‰å…ƒç´  æ— åº                            |
| scard       | è¿”å›é›†åˆä¸­å…ƒç´ çš„ä¸ªæ•°                               |
| spop        | éšæœºè¿”å›ä¸€ä¸ªå…ƒç´  å¹¶å°†å…ƒç´ åœ¨é›†åˆä¸­åˆ é™¤              |
| smove       | ä»ä¸€ä¸ªé›†åˆä¸­å‘å¦ä¸€ä¸ªé›†åˆç§»åŠ¨å…ƒç´  å¿…é¡»æ˜¯åŒä¸€ç§ç±»å‹ |
| srem        | ä»é›†åˆä¸­åˆ é™¤ä¸€ä¸ªå…ƒç´                                |
| sismember   | åˆ¤æ–­ä¸€ä¸ªé›†åˆä¸­æ˜¯å¦å«æœ‰è¿™ä¸ªå…ƒç´                      |
| srandmember | éšæœºè¿”å›å…ƒç´                                        |
| sdiff       | å»æ‰ç¬¬ä¸€ä¸ªé›†åˆä¸­å…¶å®ƒé›†åˆå«æœ‰çš„ç›¸åŒå…ƒç´              |
| sinter      | æ±‚äº¤é›†                                             |
| sunion      | æ±‚å’Œé›†                                             |

### 8.6 ZSetç±»å‹

ç‰¹ç‚¹: å¯æ’åºçš„seté›†åˆ æ’åº ä¸å¯é‡å¤

ZSET å®˜æ–¹ å¯æ’åºSET sortSet

#### 1.å†…å­˜æ¨¡å‹

![image-20200623194903967](assets/image-20200623194903967.png)

#### 2.å¸¸ç”¨å‘½ä»¤

| å‘½ä»¤                       | è¯´æ˜                         |
| -------------------------- | ---------------------------- |
| zadd                       | æ·»åŠ ä¸€ä¸ªæœ‰åºé›†åˆå…ƒç´          |
| zcard                      | è¿”å›é›†åˆçš„å…ƒç´ ä¸ªæ•°           |
| zrange å‡åº zrevrange é™åº | è¿”å›ä¸€ä¸ªèŒƒå›´å†…çš„å…ƒç´          |
| zrangebyscore              | æŒ‰ç…§åˆ†æ•°æŸ¥æ‰¾ä¸€ä¸ªèŒƒå›´å†…çš„å…ƒç´  |
| zrank                      | è¿”å›æ’å                     |
| zrevrank                   | å€’åºæ’å                     |
| zscore                     | æ˜¾ç¤ºæŸä¸€ä¸ªå…ƒç´ çš„åˆ†æ•°         |
| zrem                       | ç§»é™¤æŸä¸€ä¸ªå…ƒç´                |
| zincrby                    | ç»™æŸä¸ªç‰¹å®šå…ƒç´ åŠ åˆ†           |

### 8.7 hashç±»å‹

ç‰¹ç‚¹: value æ˜¯ä¸€ä¸ªmapç»“æ„ å­˜åœ¨key value key æ— åºçš„

#### 1.å†…å­˜æ¨¡å‹

![image-20200623200348408](assets/image-20200623200348408.png)

#### 2.å¸¸ç”¨å‘½ä»¤

| å‘½ä»¤         | è¯´æ˜                    |
| ------------ | ----------------------- |
| hset         | è®¾ç½®ä¸€ä¸ªkey/valueå¯¹     |
| hget         | è·å¾—ä¸€ä¸ªkeyå¯¹åº”çš„value  |
| hgetall      | è·å¾—æ‰€æœ‰çš„key/valueå¯¹   |
| hdel         | åˆ é™¤æŸä¸€ä¸ªkey/valueå¯¹   |
| hexists      | åˆ¤æ–­ä¸€ä¸ªkeyæ˜¯å¦å­˜åœ¨     |
| hkeys        | è·å¾—æ‰€æœ‰çš„key           |
| hvals        | è·å¾—æ‰€æœ‰çš„value         |
| hmset        | è®¾ç½®å¤šä¸ªkey/value       |
| hmget        | è·å¾—å¤šä¸ªkeyçš„value      |
| hsetnx       | è®¾ç½®ä¸€ä¸ªä¸å­˜åœ¨çš„keyçš„å€¼ |
| hincrby      | ä¸ºvalueè¿›è¡ŒåŠ æ³•è¿ç®—     |
| hincrbyfloat | ä¸ºvalueåŠ å…¥æµ®ç‚¹å€¼       |

---

## 9. æŒä¹…åŒ–æœºåˆ¶

client redis[å†…å­˜] ----->  å†…å­˜æ•°æ®- æ•°æ®æŒä¹…åŒ–-->ç£ç›˜

Rediså®˜æ–¹æä¾›äº†ä¸¤ç§ä¸åŒçš„æŒä¹…åŒ–æ–¹æ³•æ¥å°†æ•°æ®å­˜å‚¨åˆ°ç¡¬ç›˜é‡Œé¢åˆ†åˆ«æ˜¯:

- å¿«ç…§(Snapshot)
- AOF (Append Only File) åªè¿½åŠ æ—¥å¿—æ–‡ä»¶

### 9.1 å¿«ç…§(Snapshot)

#### 1. ç‰¹ç‚¹

è¿™ç§æ–¹å¼å¯ä»¥å°†æŸä¸€æ—¶åˆ»çš„æ‰€æœ‰æ•°æ®éƒ½å†™å…¥ç¡¬ç›˜ä¸­,å½“ç„¶è¿™ä¹Ÿæ˜¯**redisçš„é»˜è®¤å¼€å¯æŒä¹…åŒ–æ–¹å¼**,ä¿å­˜çš„æ–‡ä»¶æ˜¯ä»¥.rdbå½¢å¼ç»“å°¾çš„æ–‡ä»¶å› æ­¤è¿™ç§æ–¹å¼ä¹Ÿç§°ä¹‹ä¸ºRDBæ–¹å¼ã€‚

![image-20200623204303074](assets/image-20200623204303074.png)

#### 2.å¿«ç…§ç”Ÿæˆæ–¹å¼

- å®¢æˆ·ç«¯æ–¹å¼: BGSAVE å’Œ SAVEæŒ‡ä»¤
- æœåŠ¡å™¨é…ç½®è‡ªåŠ¨è§¦å‘

```markdown
# 1.å®¢æˆ·ç«¯æ–¹å¼ä¹‹BGSAVE
- a.å®¢æˆ·ç«¯å¯ä»¥ä½¿ç”¨BGSAVEå‘½ä»¤æ¥åˆ›å»ºä¸€ä¸ªå¿«ç…§,å½“æ¥æ”¶åˆ°å®¢æˆ·ç«¯çš„BGSAVEå‘½ä»¤æ—¶,redisä¼šè°ƒç”¨forkÂ¹æ¥åˆ›å»ºä¸€ä¸ªå­è¿›ç¨‹,ç„¶åå­è¿›ç¨‹è´Ÿè´£å°†å¿«ç…§å†™å…¥ç£ç›˜ä¸­,è€Œçˆ¶è¿›ç¨‹åˆ™ç»§ç»­å¤„ç†å‘½ä»¤è¯·æ±‚ã€‚
	
	`åè¯è§£é‡Š: forkå½“ä¸€ä¸ªè¿›ç¨‹åˆ›å»ºå­è¿›ç¨‹çš„æ—¶å€™,åº•å±‚çš„æ“ä½œç³»ç»Ÿä¼šåˆ›å»ºè¯¥è¿›ç¨‹çš„ä¸€ä¸ªå‰¯æœ¬,åœ¨ç±»unixç³»ç»Ÿä¸­åˆ›å»ºå­è¿›ç¨‹çš„æ“ä½œä¼šè¿›è¡Œä¼˜åŒ–:åœ¨åˆšå¼€å§‹çš„æ—¶å€™,çˆ¶å­è¿›ç¨‹å…±äº«ç›¸åŒå†…å­˜,ç›´åˆ°çˆ¶è¿›ç¨‹æˆ–å­è¿›ç¨‹å¯¹å†…å­˜è¿›è¡Œäº†å†™ä¹‹å,å¯¹è¢«å†™å…¥çš„å†…å­˜çš„å…±äº«æ‰ä¼šç»“æŸæœåŠ¡`
```

![image-20200623205132460](assets/image-20200623205132460.png)

```markdown
# 2.å®¢æˆ·ç«¯æ–¹å¼ä¹‹SAVE
- b.ï¬å®¢æˆ·ç«¯è¿˜å¯ä»¥ä½¿ç”¨SAVEå‘½ä»¤æ¥åˆ›å»ºä¸€ä¸ªå¿«ç…§,æ¥æ”¶åˆ°SAVEå‘½ä»¤çš„redisæœåŠ¡å™¨åœ¨å¿«ç…§åˆ›å»ºå®Œæ¯•ä¹‹å‰å°†ä¸å†å“åº”ä»»ä½•å…¶ä»–çš„å‘½ä»¤
```

![image-20200623205444101](assets/image-20200623205444101.png)

- **æ³¨æ„: SAVEå‘½ä»¤å¹¶ä¸å¸¸ç”¨,ä½¿ç”¨SAVEå‘½ä»¤åœ¨å¿«ç…§åˆ›å»ºå®Œæ¯•ä¹‹å‰,rediså¤„äºé˜»å¡çŠ¶æ€,æ— æ³•å¯¹å¤–æœåŠ¡**

```markdown
# 3.æœåŠ¡å™¨é…ç½®æ–¹å¼ä¹‹æ»¡è¶³é…ç½®è‡ªåŠ¨è§¦å‘
- ï¬å¦‚æœç”¨æˆ·åœ¨redis.confä¸­è®¾ç½®äº†saveé…ç½®é€‰é¡¹,redisä¼šåœ¨saveé€‰é¡¹æ¡ä»¶æ»¡è¶³ä¹‹åè‡ªåŠ¨è§¦å‘ä¸€æ¬¡BGSAVEå‘½ä»¤,å¦‚æœè®¾ç½®å¤šä¸ªsaveé…ç½®é€‰é¡¹,å½“ä»»æ„ä¸€ä¸ªsaveé…ç½®é€‰é¡¹æ¡ä»¶æ»¡è¶³,redisä¹Ÿä¼šè§¦å‘ä¸€æ¬¡BGSAVEå‘½ä»¤
```

![image-20200623210021012](assets/image-20200623210021012.png)

```markdown
# 4.æœåŠ¡å™¨æ¥æ”¶å®¢æˆ·ç«¯shutdownæŒ‡ä»¤
- å½“redisé€šè¿‡shutdownæŒ‡ä»¤æ¥æ”¶åˆ°å…³é—­æœåŠ¡å™¨çš„è¯·æ±‚æ—¶,ä¼šæ‰§è¡Œä¸€ä¸ªsaveå‘½ä»¤,é˜»å¡æ‰€æœ‰çš„å®¢æˆ·ç«¯,ä¸å†æ‰§è¡Œå®¢æˆ·ç«¯æ‰§è¡Œå‘é€çš„ä»»ä½•å‘½ä»¤,å¹¶ä¸”åœ¨saveå‘½ä»¤æ‰§è¡Œå®Œæ¯•ä¹‹åå…³é—­æœåŠ¡å™¨
```

#### 3.é…ç½®ç”Ÿæˆå¿«ç…§åç§°å’Œä½ç½®

```markdown
#1.ä¿®æ”¹ç”Ÿæˆå¿«ç…§åç§°
- dbfilename dump.rdb

# 2.ä¿®æ”¹ç”Ÿæˆä½ç½®
- dir ./
```

![image-20200623210352448](assets/image-20200623210352448.png)

----

### 9.2 AOF åªè¿½åŠ æ—¥å¿—æ–‡ä»¶

#### 1.ç‰¹ç‚¹

è¿™ç§æ–¹å¼å¯ä»¥å°†æ‰€æœ‰å®¢æˆ·ç«¯æ‰§è¡Œçš„å†™å‘½ä»¤è®°å½•åˆ°æ—¥å¿—æ–‡ä»¶ä¸­,AOFæŒä¹…åŒ–ä¼šå°†è¢«æ‰§è¡Œçš„å†™å‘½ä»¤å†™åˆ°AOFçš„æ–‡ä»¶æœ«å°¾,ä»¥æ­¤æ¥è®°å½•æ•°æ®å‘ç”Ÿçš„å˜åŒ–,å› æ­¤åªè¦redisä»å¤´åˆ°å°¾æ‰§è¡Œä¸€æ¬¡AOFæ–‡ä»¶æ‰€åŒ…å«çš„æ‰€æœ‰å†™å‘½ä»¤,å°±å¯ä»¥æ¢å¤AOFæ–‡ä»¶çš„è®°å½•çš„æ•°æ®é›†.

![image-20200623211330798](assets/image-20200623211330798.png)

#### 2.å¼€å¯AOFæŒä¹…åŒ–

åœ¨redisçš„é»˜è®¤é…ç½®ä¸­AOFæŒä¹…åŒ–æœºåˆ¶æ˜¯æ²¡æœ‰å¼€å¯çš„ï¼Œéœ€è¦åœ¨é…ç½®ä¸­å¼€å¯

```markdown
# 1.å¼€å¯AOFæŒä¹…åŒ–
- a.ä¿®æ”¹ appendonly yes å¼€å¯æŒä¹…åŒ–
- b.ä¿®æ”¹ appendfilename "appendonly.aof" æŒ‡å®šç”Ÿæˆæ–‡ä»¶åç§°
```

![image-20200623211508987](assets/image-20200623211508987.png)

#### 3.æ—¥å¿—è¿½åŠ é¢‘ç‡

```markdown
# 1.always ã€è°¨æ…ä½¿ç”¨ã€‘
- è¯´æ˜: æ¯ä¸ªrediså†™å‘½ä»¤éƒ½è¦åŒæ­¥å†™å…¥ç¡¬ç›˜,ä¸¥é‡é™ä½redisé€Ÿåº¦
- è§£é‡Š: å¦‚æœç”¨æˆ·ä½¿ç”¨äº†alwaysé€‰é¡¹,é‚£ä¹ˆæ¯ä¸ªrediså†™å‘½ä»¤éƒ½ä¼šè¢«å†™å…¥ç¡¬ç›˜,ä»è€Œå°†å‘ç”Ÿç³»ç»Ÿå´©æºƒæ—¶å‡ºç°çš„æ•°æ®ä¸¢å¤±å‡åˆ°æœ€å°‘;é—æ†¾çš„æ˜¯,å› ä¸ºè¿™ç§åŒæ­¥ç­–ç•¥éœ€è¦å¯¹ç¡¬ç›˜è¿›è¡Œå¤§é‡çš„å†™å…¥æ“ä½œ,æ‰€ä»¥rediså¤„ç†å‘½ä»¤çš„é€Ÿåº¦ä¼šå—åˆ°ç¡¬ç›˜æ€§èƒ½çš„é™åˆ¶;
- æ³¨æ„: è½¬ç›˜å¼ç¡¬ç›˜åœ¨è¿™ç§é¢‘ç‡ä¸‹200å·¦å³ä¸ªå‘½ä»¤/s ; å›ºæ€ç¡¬ç›˜(SSD) å‡ ç™¾ä¸‡ä¸ªå‘½ä»¤/s;
- è­¦å‘Š: ä½¿ç”¨SSDç”¨æˆ·è¯·è°¨æ…ä½¿ç”¨alwaysé€‰é¡¹,è¿™ç§æ¨¡å¼ä¸æ–­å†™å…¥å°‘é‡æ•°æ®çš„åšæ³•æœ‰å¯èƒ½ä¼šå¼•å‘ä¸¥é‡çš„å†™å…¥æ”¾å¤§é—®é¢˜,å¯¼è‡´å°†å›ºæ€ç¡¬ç›˜çš„å¯¿å‘½ä»åŸæ¥çš„å‡ å¹´é™ä½ä¸ºå‡ ä¸ªæœˆã€‚

# 2.everysec ã€æ¨èã€‘
- è¯´æ˜: æ¯ç§’æ‰§è¡Œä¸€æ¬¡åŒæ­¥æ˜¾å¼çš„å°†å¤šä¸ªå†™å‘½ä»¤åŒæ­¥åˆ°ç£ç›˜
- è§£é‡Šï¼š ä¸ºäº†å…¼é¡¾æ•°æ®å®‰å…¨å’Œå†™å…¥æ€§èƒ½,ç”¨æˆ·å¯ä»¥è€ƒè™‘ä½¿ç”¨everysecé€‰é¡¹,è®©redisæ¯ç§’ä¸€æ¬¡çš„é¢‘ç‡å¯¹AOFæ–‡ä»¶è¿›è¡ŒåŒæ­¥;redisæ¯ç§’åŒæ­¥ä¸€æ¬¡AOFæ–‡ä»¶æ—¶æ€§èƒ½å’Œä¸ä½¿ç”¨ä»»ä½•æŒä¹…åŒ–ç‰¹æ€§æ—¶çš„æ€§èƒ½ç›¸å·®æ— å‡ ,è€Œé€šè¿‡æ¯ç§’åŒæ­¥ä¸€æ¬¡AOFæ–‡ä»¶,rediså¯ä»¥ä¿è¯,å³ä½¿ç³»ç»Ÿå´©æºƒ,ç”¨æˆ·æœ€å¤šä¸¢å¤±ä¸€ç§’ä¹‹å†…äº§ç”Ÿçš„æ•°æ®ã€‚

# 3.no	ã€ä¸æ¨èã€‘
- è¯´æ˜: ç”±æ“ä½œç³»ç»Ÿå†³å®šä½•æ—¶åŒæ­¥ 
- è§£é‡Šï¼šæœ€åä½¿ç”¨noé€‰é¡¹,å°†å®Œå…¨æœ‰æ“ä½œç³»ç»Ÿå†³å®šä»€ä¹ˆæ—¶å€™åŒæ­¥AOFæ—¥å¿—æ–‡ä»¶,è¿™ä¸ªé€‰é¡¹ä¸ä¼šå¯¹redisæ€§èƒ½å¸¦æ¥å½±å“ä½†æ˜¯ç³»ç»Ÿå´©æºƒæ—¶,ä¼šä¸¢å¤±ä¸å®šæ•°é‡çš„æ•°æ®,å¦å¤–å¦‚æœç”¨æˆ·ç¡¬ç›˜å¤„ç†å†™å…¥æ“ä½œä¸å¤Ÿå¿«çš„è¯,å½“ç¼“å†²åŒºè¢«ç­‰å¾…å†™å…¥ç¡¬ç›˜æ•°æ®å¡«æ»¡æ—¶,redisä¼šå¤„äºé˜»å¡çŠ¶æ€,å¹¶å¯¼è‡´redisçš„å¤„ç†å‘½ä»¤è¯·æ±‚çš„é€Ÿåº¦å˜æ…¢ã€‚
```

#### 4.ä¿®æ”¹åŒæ­¥é¢‘ç‡

```markdown
# 1.ä¿®æ”¹æ—¥å¿—åŒæ­¥é¢‘ç‡
- ä¿®æ”¹appendfsync everysec|always|no æŒ‡å®š
```

![image-20200623211658910](assets/image-20200623211658910.png)

----

### 9.3 AOFæ–‡ä»¶çš„é‡å†™

#### 1. AOFå¸¦æ¥çš„é—®é¢˜

AOFçš„æ–¹å¼ä¹ŸåŒæ—¶å¸¦æ¥äº†å¦ä¸€ä¸ªé—®é¢˜ã€‚æŒä¹…åŒ–æ–‡ä»¶ä¼šå˜çš„è¶Šæ¥è¶Šå¤§ã€‚ä¾‹å¦‚æˆ‘ä»¬è°ƒç”¨incr testå‘½ä»¤100æ¬¡ï¼Œæ–‡ä»¶ä¸­å¿…é¡»ä¿å­˜å…¨éƒ¨çš„100æ¡å‘½ä»¤ï¼Œå…¶å®æœ‰99æ¡éƒ½æ˜¯å¤šä½™çš„ã€‚å› ä¸ºè¦æ¢å¤æ•°æ®åº“çš„çŠ¶æ€å…¶å®æ–‡ä»¶ä¸­ä¿å­˜ä¸€æ¡set test
100å°±å¤Ÿäº†ã€‚ä¸ºäº†å‹ç¼©aofçš„æŒä¹…åŒ–æ–‡ä»¶Redisæä¾›äº†AOFé‡å†™(ReWriter)æœºåˆ¶ã€‚

#### 2. AOFé‡å†™

ç”¨æ¥åœ¨ä¸€å®šç¨‹åº¦ä¸Šå‡å°AOFæ–‡ä»¶çš„ä½“ç§¯

#### 3. è§¦å‘é‡å†™æ–¹å¼

```markdown
# 1.å®¢æˆ·ç«¯æ–¹å¼è§¦å‘é‡å†™
- æ‰§è¡ŒBGREWRITEAOFå‘½ä»¤  ä¸ä¼šé˜»å¡redisçš„æœåŠ¡

# 2.æœåŠ¡å™¨é…ç½®æ–¹å¼è‡ªåŠ¨è§¦å‘
- é…ç½®redis.confä¸­çš„auto-aof-rewrite-percentageé€‰é¡¹ å‚åŠ ä¸‹å›¾â†“â†“â†“
- å¦‚æœè®¾ç½®auto-aof-rewrite-percentageå€¼ä¸º100å’Œauto-aof-rewrite-min-size 64mb,å¹¶ä¸”å¯ç”¨çš„AOFæŒä¹…åŒ–æ—¶,é‚£ä¹ˆå½“AOFæ–‡ä»¶ä½“ç§¯å¤§äº64M,å¹¶ä¸”AOFæ–‡ä»¶çš„ä½“ç§¯æ¯”ä¸Šä¸€æ¬¡é‡å†™ä¹‹åä½“ç§¯å¤§äº†è‡³å°‘ä¸€å€(100%)æ—¶,ä¼šè‡ªåŠ¨è§¦å‘,å¦‚æœé‡å†™è¿‡äºé¢‘ç¹,ç”¨æˆ·å¯ä»¥è€ƒè™‘å°†auto-aof-rewrite-percentageè®¾ç½®ä¸ºæ›´å¤§
```

![image-20200623212547775](assets/image-20200623212547775.png)

#### 4. é‡å†™åŸç†

**æ³¨æ„ï¼šé‡å†™aofæ–‡ä»¶çš„æ“ä½œï¼Œå¹¶æ²¡æœ‰è¯»å–æ—§çš„aofæ–‡ä»¶ï¼Œè€Œæ˜¯å°†æ•´ä¸ªå†…å­˜ä¸­çš„æ•°æ®åº“å†…å®¹ç”¨å‘½ä»¤çš„æ–¹å¼é‡å†™äº†ä¸€ä¸ªæ–°çš„aofæ–‡ä»¶,æ›¿æ¢åŸæœ‰çš„æ–‡ä»¶è¿™ç‚¹å’Œå¿«ç…§æœ‰ç‚¹ç±»ä¼¼ã€‚**

```markdown
# é‡å†™æµç¨‹
- 1. redisè°ƒç”¨fork ï¼Œç°åœ¨æœ‰çˆ¶å­ä¸¤ä¸ªè¿›ç¨‹ å­è¿›ç¨‹æ ¹æ®å†…å­˜ä¸­çš„æ•°æ®åº“å¿«ç…§ï¼Œå¾€ä¸´æ—¶æ–‡ä»¶ä¸­å†™å…¥é‡å»ºæ•°æ®åº“çŠ¶æ€çš„å‘½ä»¤
- 2. çˆ¶è¿›ç¨‹ç»§ç»­å¤„ç†clientè¯·æ±‚ï¼Œé™¤äº†æŠŠå†™å‘½ä»¤å†™å…¥åˆ°åŸæ¥çš„aofæ–‡ä»¶ä¸­ã€‚åŒæ—¶æŠŠæ”¶åˆ°çš„å†™å‘½ä»¤ç¼“å­˜èµ·æ¥ã€‚è¿™æ ·å°±èƒ½ä¿è¯å¦‚æœå­è¿›ç¨‹é‡å†™å¤±è´¥çš„è¯å¹¶ä¸ä¼šå‡ºé—®é¢˜ã€‚
- 3. å½“å­è¿›ç¨‹æŠŠå¿«ç…§å†…å®¹å†™å…¥å·²å‘½ä»¤æ–¹å¼å†™åˆ°ä¸´æ—¶æ–‡ä»¶ä¸­åï¼Œå­è¿›ç¨‹å‘ä¿¡å·é€šçŸ¥çˆ¶è¿›ç¨‹ã€‚ç„¶åçˆ¶è¿›ç¨‹æŠŠç¼“å­˜çš„å†™å‘½ä»¤ä¹Ÿå†™å…¥åˆ°ä¸´æ—¶æ–‡ä»¶ã€‚
- 4. ç°åœ¨çˆ¶è¿›ç¨‹å¯ä»¥ä½¿ç”¨ä¸´æ—¶æ–‡ä»¶æ›¿æ¢è€çš„aofæ–‡ä»¶ï¼Œå¹¶é‡å‘½åï¼Œåé¢æ”¶åˆ°çš„å†™å‘½ä»¤ä¹Ÿå¼€å§‹å¾€æ–°çš„aofæ–‡ä»¶ä¸­è¿½åŠ ã€‚
```

![image-20200623214843123](assets/image-20200623214843123.png)

----

### 9.4 æŒä¹…åŒ–æ€»ç»“

ä¸¤ç§æŒä¹…åŒ–æ–¹æ¡ˆæ—¢å¯ä»¥åŒæ—¶ä½¿ç”¨(aof),åˆå¯ä»¥å•ç‹¬ä½¿ç”¨,åœ¨æŸç§æƒ…å†µä¸‹ä¹Ÿå¯ä»¥éƒ½ä¸ä½¿ç”¨,å…·ä½“ä½¿ç”¨é‚£ç§æŒä¹…åŒ–æ–¹æ¡ˆå–å†³äºç”¨æˆ·çš„æ•°æ®å’Œåº”ç”¨å†³å®šã€‚

æ— è®ºä½¿ç”¨AOFè¿˜æ˜¯å¿«ç…§æœºåˆ¶æŒä¹…åŒ–,å°†æ•°æ®æŒä¹…åŒ–åˆ°ç¡¬ç›˜éƒ½æ˜¯æœ‰å¿…è¦çš„,é™¤äº†æŒä¹…åŒ–å¤–,ç”¨æˆ·è¿˜åº”è¯¥å¯¹æŒä¹…åŒ–çš„æ–‡ä»¶è¿›è¡Œå¤‡ä»½(æœ€å¥½å¤‡ä»½åœ¨å¤šä¸ªä¸åŒåœ°æ–¹)ã€‚

---

## 10. javaæ“ä½œRedis

### 10.1 ç¯å¢ƒå‡†å¤‡

#### 1. å¼•å…¥ä¾èµ–

```xml
<!--å¼•å…¥jedisè¿æ¥ä¾èµ–-->
<dependency>
  <groupId>redis.clients</groupId>
  <artifactId>jedis</artifactId>
  <version>2.9.0</version>
</dependency>
```

#### 2.åˆ›å»ºjediså¯¹è±¡

```java
 public static void main(String[] args) {
   //1.åˆ›å»ºjediså¯¹è±¡
   Jedis jedis = new Jedis("192.168.40.4", 6379);//1.redisæœåŠ¡å¿…é¡»å…³é—­é˜²ç«å¢™  2.redisæœåŠ¡å¿…é¡»å¼€å¯è¿œç¨‹è¿æ¥
   jedis.select(0);//é€‰æ‹©æ“ä½œçš„åº“é»˜è®¤0å·åº“
   //2.æ‰§è¡Œç›¸å…³æ“ä½œ
   //....
   //3.é‡Šæ”¾èµ„æº
   jedis.close();
 }
```

![image-20200623201932000](assets/image-20200623201932000.png)

### 10.2 æ“ä½œkeyç›¸å…³API

```java
private Jedis jedis;
    @Before
    public void before(){
        this.jedis = new Jedis("192.168.202.205", 7000);
    }
    @After
    public void after(){
        jedis.close();
    }

    //æµ‹è¯•keyç›¸å…³
    @Test
    public void testKeys(){
        //åˆ é™¤ä¸€ä¸ªkey
        jedis.del("name");
        //åˆ é™¤å¤šä¸ªkey
        jedis.del("name","age");

        //åˆ¤æ–­ä¸€ä¸ªkeyæ˜¯å¦å­˜åœ¨exits
        Boolean name = jedis.exists("name");
        System.out.println(name);

        //è®¾ç½®ä¸€ä¸ªkeyè¶…æ—¶æ—¶é—´ expire pexpire
        Long age = jedis.expire("age", 100);
        System.out.println(age);

        //è·å–ä¸€ä¸ªkeyè¶…æ—¶æ—¶é—´ ttl
        Long age1 = jedis.ttl("newage");
        System.out.println(age1);

        //éšæœºè·å–ä¸€ä¸ªkey
        String s = jedis.randomKey();

        //ä¿®æ”¹keyåç§°
        jedis.rename("age","newage");

        //æŸ¥çœ‹å¯ä»¥å¯¹åº”å€¼çš„ç±»å‹
        String name1 = jedis.type("name");
        System.out.println(name1);
        String maps = jedis.type("maps");
        System.out.println(maps);
    }
```

![image-20200627180325687](assets/image-20200627180325687.png)

### 10.3æ“ä½œStringç›¸å…³API

```java
//æµ‹è¯•Stringç›¸å…³
    @Test
    public void testString(){
        //set
        jedis.set("name","å°é™ˆ");
        //get
        String s = jedis.get("name");
        System.out.println(s);
        //mset
        jedis.mset("content","å¥½äºº","address","æµ·æ·€åŒº");
        //mget
        List<String> mget = jedis.mget("name", "content", "address");
        mget.forEach(v-> System.out.println("v = " + v));
        //getset
        String set = jedis.getSet("name", "å°æ˜");
        System.out.println(set);

        //............
    }
```

![image-20200627180352953](assets/image-20200627180352953.png)

### 10.4æ“ä½œListç›¸å…³API

```java
//æµ‹è¯•Listç›¸å…³
    @Test
    public void testList(){

        //lpush
        jedis.lpush("names1","å¼ ä¸‰","ç‹äº”","èµµæŸ³","win7");

        //rpush
        jedis.rpush("names1","xiaomingming");

        //lrange

        List<String> names1 = jedis.lrange("names1", 0, -1);
        names1.forEach(name-> System.out.println("name = " + name));

        //lpop rpop
        String names11 = jedis.lpop("names1");
        System.out.println(names11);

        //llen
        jedis.linsert("lists", BinaryClient.LIST_POSITION.BEFORE,"xiaohei","xiaobai");

      	//........

    }

```

![image-20200627180435997](assets/image-20200627180435997.png)

### 10.5æ“ä½œSetçš„ç›¸å…³API

```java
//æµ‹è¯•SETç›¸å…³
@Test
public void testSet(){

  //sadd
  jedis.sadd("names","zhangsan","lisi");

  //smembers
  jedis.smembers("names");

  //sismember
  jedis.sismember("names","xiaochen");

  //...
}
```

![image-20200627181913715](assets/image-20200627181913715.png)

### 10.6 æ“ä½œZSetç›¸å…³API

```java
//æµ‹è¯•ZSETç›¸å…³
@Test
public void testZset(){

  //zadd
  jedis.zadd("names",10,"å¼ ä¸‰");

  //zrange
  jedis.zrange("names",0,-1);

  //zcard
  jedis.zcard("names");

  //zrangeByScore
  jedis.zrangeByScore("names","0","100",0,5);

  //..

}
```

![image-20200627181947116](assets/image-20200627181947116.png)

### 10.7 æ“ä½œHashç›¸å…³API

```java
//æµ‹è¯•HASHç›¸å…³
@Test
public void testHash(){
  //hset
  jedis.hset("maps","name","zhangsan");
  //hget
  jedis.hget("maps","name");
  //hgetall
  jedis.hgetAll("mps");
  //hkeys
  jedis.hkeys("maps");
  //hvals
  jedis.hvals("maps");
  //....
}
```

![image-20200628093242527](assets/image-20200628093242527.png)

----

## 11.SpringBootæ•´åˆRedis

Spring Boot Data(æ•°æ®) Redis ä¸­æä¾›äº†**RedisTemplateå’ŒStringRedisTemplate**
ï¼Œå…¶ä¸­StringRedisTemplateæ˜¯RedisTemplateçš„å­ç±»ï¼Œä¸¤ä¸ªæ–¹æ³•åŸºæœ¬ä¸€è‡´ï¼Œä¸åŒä¹‹å¤„ä¸»è¦ä½“ç°åœ¨æ“ä½œçš„æ•°æ®ç±»å‹ä¸åŒï¼Œ**
RedisTemplateä¸­çš„ä¸¤ä¸ªæ³›å‹éƒ½æ˜¯Objectï¼Œæ„å‘³ç€å­˜å‚¨çš„keyå’Œvalueéƒ½å¯ä»¥æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œè€ŒStringRedisTemplateçš„ä¸¤ä¸ªæ³›å‹éƒ½æ˜¯Stringï¼Œæ„å‘³ç€StringRedisTemplateçš„keyå’Œvalueéƒ½åªèƒ½æ˜¯å­—ç¬¦ä¸²ã€‚**

`æ³¨æ„: ä½¿ç”¨RedisTemplateé»˜è®¤æ˜¯å°†å¯¹è±¡åºåˆ—åŒ–åˆ°Redisä¸­,æ‰€ä»¥æ”¾å…¥çš„å¯¹è±¡å¿…é¡»å®ç°å¯¹è±¡åºåˆ—åŒ–æ¥å£`

### 11.1 ç¯å¢ƒå‡†å¤‡

#### 1.å¼•å…¥ä¾èµ–

```xml
<dependency>
  <groupId>org.springframework.boot</groupId>
  <artifactId>spring-boot-starter-data-redis</artifactId>
</dependency>
```

#### 2.é…ç½®application.propertie

```properties
spring.redis.host=localhost
spring.redis.port=6379
spring.redis.database=0
```

### 11.2 ä½¿ç”¨StringRedisTemplateå’ŒRedisTemplate

```java
		@Autowired
    private StringRedisTemplate stringRedisTemplate;  //å¯¹å­—ç¬¦ä¸²æ”¯æŒæ¯”è¾ƒå‹å¥½,ä¸èƒ½å­˜å‚¨å¯¹è±¡
    @Autowired
    private RedisTemplate redisTemplate;  //å­˜å‚¨å¯¹è±¡

    @Test
    public void testRedisTemplate(){
        System.out.println(redisTemplate);
        //è®¾ç½®redistemplateå€¼ä½¿ç”¨å¯¹è±¡åºåˆ—åŒ–ç­–ç•¥
        redisTemplate.setValueSerializer(new JdkSerializationRedisSerializer());//æŒ‡å®šå€¼ä½¿ç”¨å¯¹è±¡åºåˆ—åŒ–
        //redisTemplate.opsForValue().set("user",new User("21","å°é»‘",23,new Date()));
        User user = (User) redisTemplate.opsForValue().get("user");
        System.out.println(user);
//      Set keys = redisTemplate.keys("*");
//      keys.forEach(key -> System.out.println(key));
        /*Object name = redisTemplate.opsForValue().get("name");
        System.out.println(name);*/

        //Object xiaohei = redisTemplate.opsForValue().get("xiaohei");
        //System.out.println(xiaohei);
        /*redisTemplate.opsForValue().set("name","xxxx");
        Object name = redisTemplate.opsForValue().get("name");
        System.out.println(name);*/
        /*redisTemplate.opsForList().leftPushAll("lists","xxxx","1111");
        List lists = redisTemplate.opsForList().range("lists", 0, -1);
        lists.forEach(list-> System.out.println(list));*/
    }


    //keyçš„ç»‘å®šæ“ä½œ å¦‚æœæ—¥åå¯¹æŸä¸€ä¸ªkeyçš„æ“ä½œåŠå…¶é¢‘ç¹,å¯ä»¥å°†è¿™ä¸ªkeyç»‘å®šåˆ°å¯¹åº”redistemplateä¸­,æ—¥ååŸºäºç»‘å®šæ“ä½œéƒ½æ˜¯æ“ä½œè¿™ä¸ªkey
    //boundValueOps ç”¨æ¥å¯¹Stringå€¼ç»‘å®škey
    //boundListOps ç”¨æ¥å¯¹Listå€¼ç»‘å®škey
    //boundSetOps ç”¨æ¥å¯¹Setå€¼ç»‘å®škey
    //boundZsetOps ç”¨æ¥å¯¹Zsetå€¼ç»‘å®škey
    //boundHashOps ç”¨æ¥å¯¹Hashå€¼ç»‘å®škey

    @Test
    public void testBoundKey(){
        BoundValueOperations<String, String> nameValueOperations = stringRedisTemplate.boundValueOps("name");
        nameValueOperations.set("1");
        //yuew
        nameValueOperations.set("2");
        String s = nameValueOperations.get();
        System.out.println(s);

    }


    //hashç›¸å…³æ“ä½œ opsForHash
    @Test
    public void testHash(){
        stringRedisTemplate.opsForHash().put("maps","name","å°é»‘");
        Object o = stringRedisTemplate.opsForHash().get("maps", "name");
        System.out.println(o);
    }

    //zsetç›¸å…³æ“ä½œ opsForZSet
    @Test
    public void testZSet(){
        stringRedisTemplate.opsForZSet().add("zsets","å°é»‘",10);
        Set<String> zsets = stringRedisTemplate.opsForZSet().range("zsets", 0, -1);
        zsets.forEach(value-> System.out.println(value));
    }

    //setç›¸å…³æ“ä½œ opsForSet
    @Test
    public void testSet(){
        stringRedisTemplate.opsForSet().add("sets","xiaosan","xiaosi","xiaowu");
        Set<String> sets = stringRedisTemplate.opsForSet().members("sets");
        sets.forEach(value-> System.out.println(value));
    }

    //listç›¸å…³çš„æ“ä½œopsForList
    @Test
    public void testList(){
        // stringRedisTemplate.opsForList().leftPushAll("lists","å¼ ä¸‰","æå››","ç‹äº”");
        List<String> lists = stringRedisTemplate.opsForList().range("lists", 0, -1);
        lists.forEach(key -> System.out.println(key));
    }


    //Stringç›¸å…³çš„æ“ä½œ opsForValue
    @Test
    public void testString(){
        //stringRedisTemplate.opsForValue().set("166","å¥½åŒå­¦");
        String s = stringRedisTemplate.opsForValue().get("166");
        System.out.println(s);
        Long size = stringRedisTemplate.opsForValue().size("166");
        System.out.println(size);
    }


    //keyç›¸å…³çš„æ“ä½œ
    @Test
    public void test(){
        Set<String> keys = stringRedisTemplate.keys("*");//æŸ¥çœ‹æ‰€æœ‰key
        Boolean name = stringRedisTemplate.hasKey("name");//åˆ¤æ–­æŸä¸ªkeyæ˜¯å¦å­˜åœ¨
        stringRedisTemplate.delete("age");//æ ¹æ®æŒ‡å®škeyåˆ é™¤
        stringRedisTemplate.rename("","");//ä¿®æ”¹keyçš„åç§°
        stringRedisTemplate.expire("key",10, TimeUnit.HOURS);
      	//è®¾ç½®keyè¶…æ—¶æ—¶é—´ å‚æ•°1:è®¾ç½®keyå å‚æ•°2:æ—¶é—´ å‚æ•°3:æ—¶é—´çš„å•ä½
        stringRedisTemplate.move("",1);//ç§»åŠ¨key
    }
```

---

## 12. Redis ä¸»ä»å¤åˆ¶

### 12.1 ä¸»ä»å¤åˆ¶

ä¸»ä»å¤åˆ¶æ¶æ„ä»…ä»…ç”¨æ¥è§£å†³æ•°æ®çš„å†—ä½™å¤‡ä»½,ä»èŠ‚ç‚¹ä»…ä»…ç”¨æ¥åŒæ­¥æ•°æ®

**æ— æ³•è§£å†³: 1.masterèŠ‚ç‚¹å‡ºç°æ•…éšœçš„è‡ªåŠ¨æ•…éšœè½¬ç§»**

### 12.2 ä¸»ä»å¤åˆ¶æ¶æ„å›¾

![image-20200627201722700](assets/image-20200627201722700.png)

### 12.3 æ­å»ºä¸»ä»å¤åˆ¶

```markdown
# 1.å‡†å¤‡3å°æœºå™¨å¹¶ä¿®æ”¹é…ç½®
- master
	port 6379
	bind 0.0.0.0
	
- slave1
	port 6380
	bind 0.0.0.0
	slaveof masterip masterport

- slave2
	port 6381
	bind 0.0.0.0
	slaveof masterip masterport
```

![image-20200627202443388](assets/image-20200627202443388.png)

```markdown
# 2.å¯åŠ¨3å°æœºå™¨è¿›è¡Œæµ‹è¯•
- cd /usr/redis/bin
- ./redis-server /root/master/redis.conf
- ./redis-server /root/slave1/redis.conf
- ./redis-server /root/slave2/redis.conf
```

---

## 13. Rediså“¨å…µæœºåˆ¶

### 13.1 å“¨å…µSentinelæœºåˆ¶

Sentinelï¼ˆå“¨å…µï¼‰æ˜¯Redis çš„é«˜å¯ç”¨æ€§è§£å†³æ–¹æ¡ˆï¼šç”±ä¸€ä¸ªæˆ–å¤šä¸ªSentinel å®ä¾‹ ç»„æˆçš„Sentinel
ç³»ç»Ÿå¯ä»¥ç›‘è§†ä»»æ„å¤šä¸ªä¸»æœåŠ¡å™¨ï¼Œä»¥åŠè¿™äº›ä¸»æœåŠ¡å™¨å±ä¸‹çš„æ‰€æœ‰ä»æœåŠ¡å™¨ï¼Œå¹¶åœ¨è¢«ç›‘è§†çš„ä¸»æœåŠ¡å™¨è¿›å…¥ä¸‹çº¿çŠ¶æ€æ—¶ï¼Œè‡ªåŠ¨å°†ä¸‹çº¿ä¸»æœåŠ¡å™¨å±ä¸‹çš„æŸä¸ªä»æœåŠ¡å™¨å‡çº§ä¸ºæ–°çš„ä¸»æœåŠ¡å™¨ã€‚ç®€å•çš„è¯´å“¨å…µå°±æ˜¯å¸¦æœ‰**è‡ªåŠ¨æ•…éšœè½¬ç§»åŠŸèƒ½çš„ä¸»ä»æ¶æ„**ã€‚

**æ— æ³•è§£å†³: 1.å•èŠ‚ç‚¹å¹¶å‘å‹åŠ›é—®é¢˜ 2.å•èŠ‚ç‚¹å†…å­˜å’Œç£ç›˜ç‰©ç†ä¸Šé™**

### 13.2 å“¨å…µæ¶æ„åŸç†

![image-20200627204422750](assets/image-20200627204422750.png)

### 13.3 æ­å»ºå“¨å…µæ¶æ„

```markdown
# 1.åœ¨ä¸»èŠ‚ç‚¹ä¸Šåˆ›å»ºå“¨å…µé…ç½®
- åœ¨Masterå¯¹åº”redis.confåŒç›®å½•ä¸‹æ–°å»ºsentinel.confæ–‡ä»¶ï¼Œåå­—ç»å¯¹ä¸èƒ½é”™ï¼›

# 2.é…ç½®å“¨å…µï¼Œåœ¨sentinel.confæ–‡ä»¶ä¸­å¡«å…¥å†…å®¹ï¼š
-Â sentinel monitor è¢«ç›‘æ§æ•°æ®åº“åå­—ï¼ˆè‡ªå·±èµ·åå­—ï¼‰ ip port 1

# 3.å¯åŠ¨å“¨å…µæ¨¡å¼è¿›è¡Œæµ‹è¯•
-Â redis-sentinel Â /root/sentinel/sentinel.conf
	è¯´æ˜:è¿™ä¸ªåé¢çš„æ•°å­—2,æ˜¯æŒ‡å½“æœ‰ä¸¤ä¸ªåŠä»¥ä¸Šçš„sentinelæœåŠ¡æ£€æµ‹åˆ°masterå®•æœºï¼Œæ‰ä¼šå»æ‰§è¡Œä¸»ä»åˆ‡æ¢çš„åŠŸèƒ½ã€‚
```

### 13.4 é€šè¿‡springbootæ“ä½œå“¨å…µ

```properties
# redis sentinel é…ç½®
# masterä¹¦å†™æ˜¯ä½¿ç”¨å“¨å…µç›‘å¬çš„é‚£ä¸ªåç§°
spring.redis.sentinel.master=mymaster
# è¿æ¥çš„ä¸å†æ˜¯ä¸€ä¸ªå…·ä½“redisä¸»æœº,ä¹¦å†™çš„æ˜¯å¤šä¸ªå“¨å…µèŠ‚ç‚¹
spring.redis.sentinel.nodes=192.168.202.206:26379
```

- **æ³¨æ„:å¦‚æœè¿æ¥è¿‡ç¨‹ä¸­å‡ºç°å¦‚ä¸‹é”™è¯¯:RedisConnectionException: DENIED Redis is running in protected mode because protected mode is
  enabled, no bind address was specified, no authentication password is requested to clients. In this mode connections
  are only accepted from the loopback interface. If you want to connect from external computers to Redis you may adopt
  one of the following solutions: 1) Just disable protected mode sending the command 'CONFIG SET protected-mode no' from
  the loopback interface by connecting to Redis from the same host the server is running, however MAKE SURE Redis is not
  publicly accessible from internet if you do so. Use CONFIG REWRITE to make this change permanent. 2)**
- **è§£å†³æ–¹æ¡ˆ:åœ¨å“¨å…µçš„é…ç½®æ–‡ä»¶ä¸­åŠ å…¥bind 0.0.0.0 å¼€å¯è¿œç¨‹è¿æ¥æƒé™**

![image-20200629154647970](assets/image-20200629154647970.png)

## 14. Redisé›†ç¾¤

### 14.1 é›†ç¾¤

Redisåœ¨3.0åå¼€å§‹æ”¯æŒCluster(æ¨¡å¼)æ¨¡å¼,ç›®å‰redisçš„é›†ç¾¤æ”¯æŒèŠ‚ç‚¹çš„è‡ªåŠ¨å‘ç°,æ”¯æŒslave-masteré€‰ä¸¾å’Œå®¹é”™,æ”¯æŒåœ¨çº¿åˆ†ç‰‡(sharding shard )ç­‰ç‰¹æ€§ã€‚reshard

### 14.2 é›†ç¾¤æ¶æ„å›¾

![img](assets/wpsgRnQP8.jpg)

### 14.3 é›†ç¾¤ç»†èŠ‚

```markdown
- æ‰€æœ‰çš„redisèŠ‚ç‚¹å½¼æ­¤äº’è”(PING-PONGæœºåˆ¶),å†…éƒ¨ä½¿ç”¨äºŒè¿›åˆ¶åè®®ä¼˜åŒ–ä¼ è¾“é€Ÿåº¦å’Œå¸¦å®½.
- èŠ‚ç‚¹çš„failæ˜¯é€šè¿‡é›†ç¾¤ä¸­è¶…è¿‡åŠæ•°çš„èŠ‚ç‚¹æ£€æµ‹å¤±æ•ˆæ—¶æ‰ç”Ÿæ•ˆ. 
- å®¢æˆ·ç«¯ä¸redisèŠ‚ç‚¹ç›´è¿,ä¸éœ€è¦ä¸­é—´proxyå±‚.å®¢æˆ·ç«¯ä¸éœ€è¦è¿æ¥é›†ç¾¤æ‰€æœ‰èŠ‚ç‚¹,è¿æ¥é›†ç¾¤ä¸­ä»»ä½•ä¸€ä¸ªå¯ç”¨èŠ‚ç‚¹å³å¯
- redis-clusteræŠŠæ‰€æœ‰çš„ç‰©ç†èŠ‚ç‚¹æ˜ å°„åˆ°[0-16383]slotä¸Š,cluster è´Ÿè´£ç»´æŠ¤node<->slot<->value
```

![image-20200629165226329](assets/image-20200629165226329.png)

### 14.4 é›†ç¾¤æ­å»º

åˆ¤æ–­ä¸€ä¸ªæ˜¯é›†ç¾¤ä¸­çš„èŠ‚ç‚¹æ˜¯å¦å¯ç”¨,æ˜¯é›†ç¾¤ä¸­çš„æ‰€ç”¨ä¸»èŠ‚ç‚¹é€‰ä¸¾è¿‡ç¨‹,å¦‚æœåŠæ•°ä»¥ä¸Šçš„èŠ‚ç‚¹è®¤ä¸ºå½“å‰èŠ‚ç‚¹æŒ‚æ‰,é‚£ä¹ˆå½“å‰èŠ‚ç‚¹å°±æ˜¯æŒ‚æ‰äº†,æ‰€ä»¥æ­å»ºredisé›†ç¾¤æ—¶å»ºè®®èŠ‚ç‚¹æ•°æœ€å¥½ä¸ºå¥‡æ•°ï¼Œ**æ­å»ºé›†ç¾¤è‡³å°‘éœ€è¦ä¸‰ä¸ªä¸»èŠ‚ç‚¹,ä¸‰ä¸ªä»èŠ‚ç‚¹,è‡³å°‘éœ€è¦6ä¸ªèŠ‚ç‚¹**ã€‚

```markdown
# 1.å‡†å¤‡ç¯å¢ƒå®‰è£…rubyä»¥åŠredisé›†ç¾¤ä¾èµ–
- yum install -y ruby rubygems
- gem install redis-xxx.gem

```

![image-20200627193219366](assets/image-20200627193219366.png)

![image-20200627193348905](assets/image-20200627193348905.png)

```markdown
# 2.åœ¨ä¸€å°æœºå™¨åˆ›å»º7ä¸ªç›®å½•
```

![image-20200627193849867](assets/image-20200627193849867.png)

```markdown
# 3.æ¯ä¸ªç›®å½•å¤åˆ¶ä¸€ä»½é…ç½®æ–‡ä»¶
[root@localhost ~]# cp redis-4.0.10/redis.conf 7000/
[root@localhost ~]# cp redis-4.0.10/redis.conf 7001/
[root@localhost ~]# cp redis-4.0.10/redis.conf 7002/
[root@localhost ~]# cp redis-4.0.10/redis.conf 7003/
[root@localhost ~]# cp redis-4.0.10/redis.conf 7004/
[root@localhost ~]# cp redis-4.0.10/redis.conf 7005/
[root@localhost ~]# cp redis-4.0.10/redis.conf 7006/
```

![image-20200627194103354](assets/image-20200627194103354.png)

```markdown
# 4.ä¿®æ”¹ä¸åŒç›®å½•é…ç½®æ–‡ä»¶
- port 	6379 .....                		 //ä¿®æ”¹ç«¯å£
- bind  0.0.0.0                   		 //å¼€å¯è¿œç¨‹è¿æ¥
- cluster-enabledÂ  yes 	        			 //å¼€å¯é›†ç¾¤æ¨¡å¼
- cluster-config-fileÂ  nodes-port.conf //é›†ç¾¤èŠ‚ç‚¹é…ç½®æ–‡ä»¶
- cluster-node-timeoutÂ  5000      	   //é›†ç¾¤èŠ‚ç‚¹è¶…æ—¶æ—¶é—´
- appendonlyÂ  yes   		               //å¼€å¯AOFæŒä¹…åŒ–

# 5.æŒ‡å®šä¸åŒç›®å½•é…ç½®æ–‡ä»¶å¯åŠ¨ä¸ƒä¸ªèŠ‚ç‚¹
- [root@localhost bin]# ./redis-server  /root/7000/redis.conf
- [root@localhost bin]# ./redis-server  /root/7001/redis.conf
- [root@localhost bin]# ./redis-server  /root/7002/redis.conf
- [root@localhost bin]# ./redis-server  /root/7003/redis.conf
- [root@localhost bin]# ./redis-server  /root/7004/redis.conf
- [root@localhost bin]# ./redis-server  /root/7005/redis.conf
- [root@localhost bin]# ./redis-server  /root/7006/redis.conf
```

![image-20200627194913866](assets/image-20200627194913866.png)

```markdown
# 6.æŸ¥çœ‹è¿›ç¨‹
- [root@localhost bin]# ps aux|grep redis
```

![image-20200627194954143](assets/image-20200627194954143.png)

#### 1.åˆ›å»ºé›†ç¾¤

```markdown
# 1.å¤åˆ¶é›†ç¾¤æ“ä½œè„šæœ¬åˆ°binç›®å½•ä¸­
- [root@localhost bin]# cp /root/redis-4.0.10/src/redis-trib.rb .

# 2.åˆ›å»ºé›†ç¾¤
- ./redis-trib.rb create --replicas 1 192.168.202.205:7000 192.168.202.205:7001 192.168.202.205:7002 192.168.202.205:7003 192.168.202.205:7004 192.168.202.205:7005
```

![image-20200627195601307](assets/image-20200627195601307.png)

```markdown
# 3.é›†ç¾¤åˆ›å»ºæˆåŠŸå‡ºç°å¦‚ä¸‹æç¤º
```

![image-20200627195647767](assets/image-20200627195647767.png)

#### 2.æŸ¥çœ‹é›†ç¾¤çŠ¶æ€

```markdown
# 1.æŸ¥çœ‹é›†ç¾¤çŠ¶æ€ check [åŸå§‹é›†ç¾¤ä¸­ä»»æ„èŠ‚ç‚¹] [æ— ]
- ./redis-trib.rb check 192.168.202.205:7000

# 2.é›†ç¾¤èŠ‚ç‚¹çŠ¶æ€è¯´æ˜
- ä¸»èŠ‚ç‚¹ 
	ä¸»èŠ‚ç‚¹å­˜åœ¨hash slots,ä¸”ä¸»èŠ‚ç‚¹çš„hash slots æ²¡æœ‰äº¤å‰
	ä¸»èŠ‚ç‚¹ä¸èƒ½åˆ é™¤
	ä¸€ä¸ªä¸»èŠ‚ç‚¹å¯ä»¥æœ‰å¤šä¸ªä»èŠ‚ç‚¹
	ä¸»èŠ‚ç‚¹å®•æœºæ—¶å¤šä¸ªå‰¯æœ¬ä¹‹é—´è‡ªåŠ¨é€‰ä¸¾ä¸»èŠ‚ç‚¹

- ä»èŠ‚ç‚¹
	ä»èŠ‚ç‚¹æ²¡æœ‰hash slots
	ä»èŠ‚ç‚¹å¯ä»¥åˆ é™¤
	ä»èŠ‚ç‚¹ä¸è´Ÿè´£æ•°æ®çš„å†™,åªè´Ÿè´£æ•°æ®çš„åŒæ­¥
```

#### 3.æ·»åŠ ä¸»èŠ‚ç‚¹

```markdown
# 1.æ·»åŠ ä¸»èŠ‚ç‚¹ add-node [æ–°åŠ å…¥èŠ‚ç‚¹] [åŸå§‹é›†ç¾¤ä¸­ä»»æ„èŠ‚ç‚¹]
- ./redis-trib.rb  add-node 192.168.1.158:7006  192.168.1.158:7005
- æ³¨æ„:
	1.è¯¥èŠ‚ç‚¹å¿…é¡»ä»¥é›†ç¾¤æ¨¡å¼å¯åŠ¨
	2.é»˜è®¤æƒ…å†µä¸‹è¯¥èŠ‚ç‚¹å°±æ˜¯ä»¥masterèŠ‚ç‚¹å½¢å¼æ·»åŠ 
```

#### 4.æ·»åŠ ä»èŠ‚ç‚¹

```markdown
# 1.æ·»åŠ ä»èŠ‚ç‚¹ add-node --slave [æ–°åŠ å…¥èŠ‚ç‚¹] [é›†ç¾¤ä¸­ä»»æ„èŠ‚ç‚¹]
- ./redis-trib.rb  add-node --slave 192.168.1.158:7006 192.168.1.158:7000
- æ³¨æ„:
	å½“æ·»åŠ å‰¯æœ¬èŠ‚ç‚¹æ—¶æ²¡æœ‰æŒ‡å®šä¸»èŠ‚ç‚¹,redisä¼šéšæœºç»™å‰¯æœ¬èŠ‚ç‚¹è¾ƒå°‘çš„ä¸»èŠ‚ç‚¹æ·»åŠ å½“å‰å‰¯æœ¬èŠ‚ç‚¹
	
# 2.ä¸ºç¡®å®šçš„masterèŠ‚ç‚¹æ·»åŠ ä¸»èŠ‚ç‚¹ add-node --slave --master-id masterèŠ‚ç‚¹id [æ–°åŠ å…¥èŠ‚ç‚¹] [é›†ç¾¤ä»»æ„èŠ‚ç‚¹]
- ./redis-trib.rb  add-node --slave --master-id 3c3a0c74aae0b56170ccb03a76b60cfe7dc1912e 127.0.0.1:7006  127.0.0.1:7000
```

#### 5.åˆ é™¤å‰¯æœ¬èŠ‚ç‚¹

```markdown
# 1.åˆ é™¤èŠ‚ç‚¹ del-node [é›†ç¾¤ä¸­ä»»æ„èŠ‚ç‚¹] [åˆ é™¤èŠ‚ç‚¹id]
- ./redis-trib.rb  del-node 127.0.0.1:7002 0ca3f102ecf0c888fc7a7ce43a13e9be9f6d3dd1
- æ³¨æ„:
 1.è¢«åˆ é™¤çš„èŠ‚ç‚¹å¿…é¡»æ˜¯ä»èŠ‚ç‚¹æˆ–æ²¡æœ‰è¢«åˆ†é…hash slotsçš„èŠ‚ç‚¹
```

#### 6.é›†ç¾¤åœ¨çº¿åˆ†ç‰‡

```markdown
# 1.åœ¨çº¿åˆ†ç‰‡ reshard [é›†ç¾¤ä¸­ä»»æ„èŠ‚ç‚¹] [æ— ]
- ./redis-trib.rb  reshard  192.168.1.158:7000
```

----

## 15.Rediså®ç°åˆ†å¸ƒå¼Sessionç®¡ç† ğŸ’¡

### 15.1 ç®¡ç†æœºåˆ¶

**redisçš„sessionç®¡ç†æ˜¯åˆ©ç”¨springæä¾›çš„sessionç®¡ç†è§£å†³æ–¹æ¡ˆ,å°†ä¸€ä¸ªåº”ç”¨sessionäº¤ç»™Rediså­˜å‚¨,æ•´ä¸ªåº”ç”¨ä¸­æ‰€æœ‰sessionçš„è¯·æ±‚éƒ½ä¼šå»redisä¸­è·å–å¯¹åº”çš„sessionæ•°æ®ã€‚**

![image-20200628201643358](assets/image-20200628201643358.png)

### 15.2 å¼€å‘Sessionç®¡ç†

#### 1. å¼•å…¥ä¾èµ–

```xml
<dependency>
  <groupId>org.springframework.session</groupId>
  <artifactId>spring-session-data-redis</artifactId>
</dependency>
```

#### 2. å¼€å‘Sessionç®¡ç†é…ç½®ç±»

```java
@Configuration
@EnableRedisHttpSession
public class RedisSessionManager {
   
}
```

#### 3.æ‰“åŒ…æµ‹è¯•å³å¯

----



